<!DOCTYPE html>
<html lang="pt-br" dir="ltr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Catálogo de Discos - Trabalho 3 Web 1</title>

  <!-- SEO Meta Tags -->
  <meta name="description"
    content="Catálogo digital de discos com imagens e descrições detalhadas. Explore nossa coleção de álbuns musicais." />
  <meta name="keywords" content="discos, álbuns, música, catálogo musical, coleção de discos" />
  <meta name="author" content="Seu Nome" />
  <meta name="robots" content="index, follow" />

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://seu-site.com/" />
  <meta property="og:title" content="Catálogo de Discos" />
  <meta property="og:description"
    content="Explore nossa coleção digital de discos com imagens e descrições detalhadas." />
  <meta property="og:image" content="https://seu-site.com/imagem-preview.jpg" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content="https://seu-site.com/" />
  <meta name="twitter:title" content="Catálogo de Discos" />
  <meta name="twitter:description"
    content="Explore nossa coleção digital de discos com imagens e descrições detalhadas." />
  <meta name="twitter:image" content="https://seu-site.com/imagem-preview.jpg" />

  <!-- Theme Color for browsers -->
  <meta name="theme-color" content="#333333" />

  <!-- Preconnect to external domains -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://code.jquery.com">
  <link rel="preconnect" href="https://ucsdiscosapi.azurewebsites.net">

  <!-- Preload critical resources -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" as="style"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"
    onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="https://code.jquery.com/jquery-3.7.1.min.js" as="script"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous" />
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" as="script"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous" />
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" as="script"
    integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous" />

  <!-- Existing stylesheet links with additional attributes -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

  <!-- Critical CSS inline -->
  <style>
    /* Critical rendering path styles */
    body.dark-mode {
      background-color: #333;
      color: #fff;
      min-height: 100vh;
    }

    #loading {
      padding: 20px;
      margin-top: 20px;
    }
  </style>

  <style>
    .mx-muito {
      padding: 0px 15px;
    }

    @media (min-width: 768px) {
      .mx-muito {
        padding: 0px 50px;
      }
    }

    @media (min-width: 992px) {
      .mx-muito {
        padding: 0px 100px;
      }
    }

    /* Estilo das imagens */
    #image-container img {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      width: 100%;
      height: auto;
      transition: transform 0.2s;
    }

    #image-container img:hover {
      transform: scale(1.02);
    }

    @media (max-width: 576px) {
      #image-container .col-12 {
        padding: 10px;
      }
    }

    /* Modal styles for mobile */
    @media (max-width: 576px) {
      .modal-dialog {
        margin: 0.5rem;
        max-width: none;
      }

      .modal-body {
        padding: 1rem;
      }
    }

    /* Scroll to top button adjustments */
    #scroll-to-top {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      padding: 10px;
      touch-action: manipulation;
    }

    @media (max-width: 576px) {
      #scroll-to-top {
        bottom: 15px;
        right: 15px;
        width: 35px;
        height: 35px;
      }
    }

    /* Touch-friendly adjustments */
    @media (hover: none) {
      .clickable-image {
        -webkit-tap-highlight-color: transparent;
      }
    }

    body.dark-mode {
      background-color: #333;
      color: #fff;
      min-height: 100vh;
    }

    #loading {
      padding: 20px;
      margin-top: 20px;
    }

    /* Dark theme modal styles */
    .dark-mode .modal-content {
      background-color: #2b2b2b;
      border: 1px solid #444;
    }

    .dark-mode .modal-header {
      border-bottom: 1px solid #444;
    }

    .dark-mode .modal-footer {
      border-top: 1px solid #444;
    }

    .dark-mode .btn-close {
      filter: invert(1) grayscale(100%) brightness(200%);
    }

    .dark-mode .modal-title {
      color: #fff;
    }

    .fade-in {
      opacity: 0;
      transition: opacity 0.5s ease-in;
    }

    .fade-in.show {
      opacity: 1;
    }

    #scroll-to-top {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: none;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
    }

    #scroll-to-top {
      color: #f8f9fa;
      background-color: #2f2f2f;
    }

    #scroll-to-top.visible {
      display: block;
      opacity: 0.8;
    }

    #scroll-to-top:hover {
      color: #f8f9fa;
      background-color: #6a6a6a;
    }
  </style>

  <!-- Load jQuery first without defer -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

  <!-- Load Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
    integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
    crossorigin="anonymous"></script>

</head>

<body class="dark-mode" itemscope itemtype="http://schema.org/WebPage">
  <div class="container-fluid px-5">
    <div class="mt-5 mx-muito">
      <h1>Discos</h1>
      <div id="image-container" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4"></div>
      <div id="loading" class="row justify-content-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- #region Templates -->
  <template id="image-template">
    <div class="col-12 col-md-3 rounded-3" id>
      <img class="rounded-3 mb-3 clickable-image" loading="lazy" decoding="async" src alt style="
            object-fit: cover;
            aspect-ratio: 1/1;
            width: 100%;
            cursor: pointer;
          " />
    </div>
  </template>

  <!-- Modal -->
  <div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <!-- loading -->
        <div class="modal-body d-flex justify-content-center" id="modal-loading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        <!-- error -->
        <div class="modal-body d-none" id="modal-error">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
            class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2 text-danger" viewBox="0 0 16 16">
            <path
              d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
          </svg>
          <div>
            Ops! Ocorreu um erro ao carregar os detalhes do disco.
          </div>
        </div>
        <div class="modal-header" id="modal-header">
          <h5 class="modal-title text-white" id="imageModalLabel"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-white" id="modal-body">
          <img class="w-100 rounded-3 mb-3" id="modalImage" src alt />
          <p id="modalDescSecundaria" class="mt-2"></p>
        </div>
        <div class="modal-footer" id="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Fechar
          </button>
        </div>
      </div>
    </div>
  </div>
  </div>
  <!-- #endregion -->

  <button id="scroll-to-top" title="Voltar ao topo" class="d-flex justify-content-center align-items-center"
    data-bs-toggle="tooltip" data-bs-placement="left">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
      <path d="M8 4.5l-5 5h10l-5-5z" />
    </svg>
  </button>
  <!-- Load jQuery first without defer -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous" defer></script>

  <script>
    document.onreadystatechange = function () {
      if (document.readyState === 'complete') {
        $(document).ready(async function () {
          async function optimizeImage(base64Image) {
            return new Promise((resolve) => {
              const img = new Image();
              img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // Set max dimensions
                const maxWidth = 800;
                const maxHeight = 800;

                let width = img.width;
                let height = img.height;

                // Calculate new dimensions while maintaining aspect ratio
                if (width > height) {
                  if (width > maxWidth) {
                    height *= maxWidth / width;
                    width = maxWidth;
                  }
                } else {
                  if (height > maxHeight) {
                    width *= maxHeight / height;
                    height = maxHeight;
                  }
                }

                canvas.width = width;
                canvas.height = height;

                // Draw and compress
                ctx.drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL('image/jpeg', 0.8));
              };
              img.src = base64Image;
            });
          }

          const baseUrl = "https://ucsdiscosapi.azurewebsites.net";
          let token = "";
          const quantidade = 12;
          let fetched = 0;
          let fullyLoaded = false;

          // Replace the old tooltip initialization with this
          const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
          const tooltipList = [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));

          // Add these variables at the top with other declarations
          let isScrolling = false;
          let scrollTimeout;
          let touchStartY;

          async function autenticar() {
            const endpoint = "Discos/autenticar";
            const url_autenticar = `${baseUrl}/${endpoint}`;

            const response = await fetch(url_autenticar, {
              method: "POST",
              headers: {
                ChaveApi: "8175fA5f6098c5301022f475da32a2aa",
                accept: "*/*",
              },
            });

            if (!response.ok) {
              // TODO(marhaubrich): Tratar o erro de forma mais adequada
              console.log("Erro ao autenticar");
              return;
            }

            token = await response.text();
          }

          function loading(active) {
            const loading = $("#loading");
            if (active) {
              loading.toggleClass("d-flex", true);
              loading.toggleClass("d-none", false);
            } else {
              loading.toggleClass("d-flex", false);
              loading.toggleClass("d-none", true);
            }
          }

          function clearModal() {
            const $modalImage = $("#modalImage");
            $modalImage.attr("src", "").attr("alt", "");

            const $modalTitle = $("#imageModalLabel");
            $modalTitle.text("");

            const $modalDescSecundaria = $("#modalDescSecundaria");
            $modalDescSecundaria.text("");
          }

          function modalLoading(loading, isError = false) {
            const $modalLoading = $("#modal-loading");
            const $modalHeader = $("#modal-header");
            const $modalBody = $("#modal-body");
            const $modalFooter = $("#modal-footer");
            const $modalError = $("#modal-error");

            function show($element, active, flex = false) {
              $element.toggleClass("d-none", !active);
              $element.toggleClass("d-flex", active && flex);
              $element.toggleClass("d-block", active && !flex);
              if (active) {
                $element.addClass("fade-in");
                setTimeout(() => $element.addClass("show"), 10);
              } else {
                $element.removeClass("show");
                setTimeout(() => $element.removeClass("fade-in"), 500);
              }
            }

            show($modalLoading, loading && !isError, true);
            show($modalError, isError, true);
            show($modalHeader, !loading && !isError, true);
            show($modalBody, !loading && !isError);
            show($modalFooter, !loading && !isError, true);
          }

          async function setModalData($img) {
            clearModal();
            modalLoading(true);
            const id = $img.parent().attr("id");

            // get data from API
            const endpoint = `Discos/record`;

            const url = `${baseUrl}/${endpoint}?numero=${id}`;
            const response = await fetch(url, {
              method: "GET",
              headers: {
                TokenApiUCS: token,
                accept: "*/*",
              },
            });

            if (!response.ok) {
              console.error("Erro ao buscar os dados do disco");
              modalLoading(false, true);
              return;
            }

            const data = await response.json();
            const base64Image = `data:image/png;base64,${data.imagemEmBase64}`;
            const descricaoPrimaria = data.descricaoPrimaria;
            const descricaoSecundaria = data.descricaoSecundaria;

            const $modalImage = $("#modalImage");
            $modalImage.attr("src", base64Image).attr("alt", descricaoPrimaria);

            const $modalTitle = $("#imageModalLabel");
            $modalTitle.text(descricaoPrimaria);

            const $modalDescSecundaria = $("#modalDescSecundaria");
            $modalDescSecundaria.text(descricaoSecundaria);

            modalLoading(false);
          }

          function openModal($img) {
            setModalData($img);
            $("#imageModal").modal("show");
          }

          // Replace the click handler section with this improved version
          function attachImageHandlers() {
            $(".clickable-image")
              .off("click touchstart touchend")
              .on("touchstart", function (e) {
                touchStartY = e.originalEvent.touches[0].clientY;
              })
              .on("touchend", function (e) {
                e.preventDefault();
                const touchEndY = e.originalEvent.changedTouches[0].clientY;
                const touchDiff = Math.abs(touchEndY - touchStartY);

                if (touchDiff < 10 && !isScrolling) { // Only trigger if it's a tap, not a scroll
                  const $img = $(this);
                  openModal($img);
                }
              })
              .on("click", function (e) {
                if (!isScrolling) {
                  const $img = $(this);
                  openModal($img);
                }
              });
          }

          // Update the getDiscos function to use the new handler
          async function getDiscos(numeroInicio = 1, quantidade = 12) {
            loading(true);
            if (!token) {
              console.log("Token não encontrado. Autentique primeiro.");
              loading(false);
              return;
            }
            const response = await fetch(
              `${baseUrl}/Discos/records?numeroInicio=${numeroInicio}&quantidade=${quantidade}`,
              {
                method: "GET",
                headers: {
                  TokenApiUCS: token,
                  accept: "*/*",
                },
              }
            );

            if (!response.ok) {
              const errorText = await response.text();
              if (
                errorText.includes("maior do que a quantidade de registros") &&
                quantidade > 1
              ) {
                getDiscos(1, quantidade - 1);
                return;
              }
              if (
                errorText.includes("maior do que a quantidade de registros") ||
                errorText.includes(
                  "número de início informado esta fora do intervalo permitido."
                )
              ) {
                console.log("Todos os discos foram carregados");
                loading(false);
                fullyLoaded = true;
                return;
              }
              console.log("Erro ao buscar os discos");
              loading(false);
              return;
            }

            const data = await response.json();

            for (const item of data) {
              const base64Image = `data:image/png;base64,${item.imagemEmBase64}`;
              const optimizedImage = await optimizeImage(base64Image);

              const $imageTemplate = $("#image-template").html();
              const $imageDiv = $($imageTemplate);
              $imageDiv.attr("id", item.id);

              const $img = $imageDiv.find("img");
              $img
                .attr("src", optimizedImage)
                .attr("alt", item.descricaoPrimaria)
                .data("descPrimaria", item.descricaoPrimaria)
                .data("descSecundaria", item.descricaoSecundaria);

              $("#image-container").append($imageDiv);
            }

            attachImageHandlers();

            fetched += data.length;

            loading(false);
          }

          async function getNextPage() {
            const numeroInicio = fetched + 1;
            await getDiscos(numeroInicio, quantidade);
          }

          await autenticar();
          await getDiscos();

          // Improve scroll performance
          $(window).scroll(function () {
            isScrolling = true;
            clearTimeout(scrollTimeout);

            scrollTimeout = setTimeout(function () {
              isScrolling = false;
            }, 150); // Reset scroll state after scrolling stops

            // Rest of your existing scroll logic
            if (fullyLoaded) return;

            const scrollPosition = $(window).scrollTop() + $(window).height();
            const threshold = $(document).height() - 100;

            if (scrollPosition > threshold) {
              if (!$("#loading").hasClass("d-none")) return;
              getNextPage();
            }

            // Scroll to top button visibility
            const mustShow = $(window).scrollTop() > 300;
            scrollToTopButton.toggleClass("visible", mustShow);
            setTimeout(() => {
              scrollToTopButton.toggleClass("d-none", !mustShow);
              scrollToTopButton.toggleClass("d-flex", mustShow);
            }, 300);
          });

          const scrollToTopButton = $("#scroll-to-top");

          // Smooth scroll with better performance
          scrollToTopButton
            .on('touchstart click', function (e) {
              e.preventDefault();
              const tooltip = bootstrap.Tooltip.getInstance(this);
              if (tooltip) {
                tooltip.hide();
              }
              $('html, body').animate({ scrollTop: 0 }, 'fast');
            })
            .on('touchend', function (e) {
              e.preventDefault();
              const tooltip = bootstrap.Tooltip.getInstance(this);
              if (tooltip) {
                tooltip.hide();
              }
            });

          // Re-enable tooltips after they're hidden
          scrollToTopButton.on('hidden.bs.tooltip', function () {
            const tooltip = bootstrap.Tooltip.getInstance(this);
            if (tooltip) {
              tooltip.enable();
            }
          });

          function isNearBottom() {
            const windowHeight = $(window).height();
            const documentHeight = $(document).height();
            const scrollTop = $(window).scrollTop();
            const buffer = window.innerWidth <= 768 ? 1000 : 100; // Larger buffer for mobile

            return (windowHeight + scrollTop + buffer) >= documentHeight;
          }

          let loadingNextPage = false;
          async function tryLoadNextPage() {
            if (fullyLoaded || loadingNextPage || $("#loading").hasClass("d-none") === false) {
              return;
            }

            loadingNextPage = true;
            try {
              await getNextPage();
            } finally {
              loadingNextPage = false;
            }
          }

          // Replace the scroll handler with this improved version
          let scrollThrottle;
          $(window).on('scroll touchmove', function () {
            isScrolling = true;
            clearTimeout(scrollTimeout);
            clearTimeout(scrollThrottle);

            scrollThrottle = setTimeout(function () {
              if (isNearBottom()) {
                tryLoadNextPage();
              }

              // Scroll to top button visibility
              const mustShow = $(window).scrollTop() > 300;
              scrollToTopButton.toggleClass("visible", mustShow);
              setTimeout(() => {
                scrollToTopButton.toggleClass("d-none", !mustShow);
                scrollToTopButton.toggleClass("d-flex", mustShow);
              }, 300);
            }, 100); // Throttle scroll events

            scrollTimeout = setTimeout(function () {
              isScrolling = false;
            }, 150);
          });

          // Add intersection observer as backup for scroll detection
          const options = {
            root: null,
            rootMargin: '0px',
            threshold: 0.1
          };

          const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                tryLoadNextPage();
              }
            });
          }, options);

          // Observe the loading element
          observer.observe(document.getElementById('loading'));
        });
      }
    };

  </script>
</body>

</html>